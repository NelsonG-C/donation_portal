{% load humanize %}
{% load bootstrap3 %}
{% load static from staticfiles %}
{% load pin_payment_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Donate to Effective Altruism Australia</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<link rel="apple-touch-icon" href="apple-touch-icon.png">-->

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"
          integrity="" crossorigin="anonymous">

    <!-- Optional theme -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"-->
          <!--integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">-->

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>

    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.16.0/jquery.validate.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.payment/3.0.0/jquery.payment.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.16.0/additional-methods.min.js"></script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/ractive/0.9.0-build-91/ractive.js'></script>

    <link href="{% static 'css/pledge.css' %}" type="text/css" media="all" rel="stylesheet">
    <link href="{% static 'css/process_steps.css' %}" type="text/css" media="all" rel="stylesheet">
    <link href="{% static 'css/credit_card.css' %}" type="text/css" media="all" rel="stylesheet">
    <script type="text/javascript" src="{% static 'js/credit_card.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/charities.js' %}"></script>

    {% pin_header "test" %}

</head>

<body>


<div id="ractive_base"></div>

<script id="ractive_template" type="text/html">
<div class="container">
    <div class="stepwizard">
        <div class="stepwizard-row setup-panel">
            <div class="stepwizard-step">
                <a href="#" type="button" class="btn btn-circle [[step === 1 ? 'current-step' : 'completed-step' ]]" on-click="@this.set_step(1)">1</a>
                <p>Charities</p>
            </div>
            <div class="stepwizard-step">
                <a href="#" type="button" class="btn btn-circle [[step === 2 ? 'current-step' : step > 2 ? 'completed-step' : 'disabled-step' ]]" disabled=[[step < 2]] on-click="@this.set_step(2)">2</a>
                <p>Payment</p>
            </div>
            <div class="stepwizard-step">
                <a href="#" type="button" class="btn btn-circle [[step === 3 ? 'current-step' : 'disabled-step' ]]" disabled=[[step < 3]] on-click="@this.set_step(3)">3</a>
                <p>Confirmation</p>
            </div>
        </div>
    </div>
</div>

<div class="container" >
    <div class="donation-step [[step !== 1 ? 'collapse' : '']]" id="step-1">
        <p style="margin: 15px 0;">Please select a charity. We will grant 100% of your donation to them.</p>
        <div class="charities-container">
            [[#charities:i]]
                [[#if show_on_website ]]
                <div class="charity">
                    <div class="charity-info">
                        <img class="charity-img" style="margin-top:[[ image_top_margin ]]px;"
                             src="static/[[ website_image ]]" alt="[[ website_label ]]">
                        <h2 class="charity-title">[[ website_label ]]</h2>
                    </div>
                    <div class="hover-overlay">
                        <a class="charity-details charityClick" on-click='@this.charity_click(name)' href="#">
                            <b>[[ website_label ]] </b> [[ website_description ]]
                        </a>
                    </div>
                </div>
                [[/if ]]
            [[/charities]]
        </div>
    </div>

    [[#if selected_charity && selected_charity.name==='Against Malaria Foundation' && step === 2]]
    <div class="donation-step" id="step-2">
        <div class="selected-charity-box">
            <a href='https://www.againstmalaria.com/Donation.aspx?GroupID=86'>
            <img class="charity-img" src="static/[[ selected_charity.website_image ]]">
            </a>
            <p class="donation-info">
                Donations to the Against Malaria Foundation are tax deductible in Australia.
                We prefer that you donate to the Against Malaria Foundation directly at
                <a href='https://www.againstmalaria.com/Donation.aspx?GroupID=86'>https://www.againstmalaria.com/Donation.aspx?GroupID=86</a>.
            </p>
        </div>
    </div>
    [[/if]]

    <div class="donation-step [[(step !== 2 | selected_charity.name==='Against Malaria Foundation') ? 'collapse' : '']]" id="step-2">
        [[#if selected_charity]]
        [[! We need to enclose this in an 'if' to avoid a 404 when the charity is not set but we try to load its logo. ]]
        <div class="selected-charity-box">
            <img class="charity-img" src="static/[[ selected_charity.website_image ]]">
            <p class="donation-info">
                You have earmarked your donation for [[ selected_charity.name ]].
                We will grant 100% of your donation to them.
            </p>
        </div>
        [[/if ]]
        <form on-submit="submit" id='id_pledge_form'>
            {% csrf_token %}

            <h1>How would you like to donate?</h1>
            <div class="donation-type-section">
                <div data-toggle="buttons">
                    <div class="btn-group">
                        <button type="button"
                                class="btn btn-lg [[recurring == false ? 'btn-primary' : 'btn-default' ]]"
                                on-click='@this.set_recurring(false)'>One-Time
                        </button>

                        <button type="button"
                                class="btn btn-lg [[recurring ? 'btn-primary' : 'btn-default' ]]"
                            on-click='@this.set_recurring(true)'>Monthly
                        </button>
                    </div>
                </div>
            </div>

            <div class="donation-amount-section">
                <span class="section-label">
                    Amount:
                </span>
                {% for amt_text, amt_val in form.donation_amounts %}
                    <button type="button"
                            class="btn [[donation_amount === {{ amt_val }} ? 'btn-primary' : 'btn-default' ]]"
                            on-click='@this.set_donation_amount({{ amt_val }})'
                            id="id_{{ amt_val }}"
                            value={{ amt_val }}>{{ amt_text }}</button>
                {% endfor %}

                <button type="button"
                        class="btn [[is_custom_amount ? 'btn-primary' : 'btn-default' ]]"
                        on-click="@this.show_other_donation_amount()"
                        value="other">Other
                </button>
                <div class="form-group [[ is_custom_amount ? '' : 'collapse' ]]" id="form_donation_amount">
                    <label class="sr-only control-label" for="id_amount">Amount</label>
                    <div class="input-group">
                        <span class="input-group-addon">$</span>
                        <input class="form-control" type="number" id="id_amount" step="1" min="2" name="amount" placeholder="Amount" title="" value="[[ donation_amount ]]">
                    </div>
                </div>
            </div>

            <div class="panel panel-default form-container details-section donor-details-section">
                <div class="panel-body form-horizontal">
                    <legend>Donor Details</legend>
                    <div class="form-group" id="form_first_name">
                        <label class="control-label col-sm-3" for="id_first_name">Name</label>
                        <div class="col-sm-9">
                            <input class="form-control" type="text" id="id_first_name" maxlength="1024" name="first_name" placeholder="Name" title="" value="">
                        </div>
                    </div>

                    <div class="form-group" id="form_email">
                        <label class="control-label col-sm-3" for="id_email">Email</label>
                        <div class="col-sm-9">
                            <input class="form-control" type="email" id="id_email" maxlength="254" name="email" placeholder="Email"  title="" value="" required aria-required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-sm-3 long-control-label" for="id_how_did_you_hear_about_us">How did you hear about us?</label>
                        <div class="col-sm-9">
                            <select class="form-control" id="id_how_did_you_hear_about_us" name="how_did_you_hear_about_us">
                                <option value="" disabled selected>---------</option>
                                <option value="The Life You Can Save">The Life You Can Save</option>
                                <option value="News">News</option>
                                <option value="Advertising">Advertising</option>
                                <option value="GiveWell">GiveWell</option>
                                <option value="From the charity (SCI, Evidence Action, GiveDirectly)">From the charity (SCI, Evidence Action, GiveDirectly)</option>
                                <option value="Search engine (Google etc.)">Search engine (Google etc.)</option>
                                <option value="Friend">Friend</option>
                                <option value="Giving What We Can">Giving What We Can</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="id_formgroup_subscribe_to_updates">
                        <div class="checkbox col-sm-offset-3">
                            <label for="id_subscribe_to_updates"><input type="checkbox" id="id_subscribe_to_updates" name="subscribe_to_updates" checked> Send me news and updates</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel panel-default form-container details-section payment-details-section">
                <div class="panel-body form-horizontal">
                    <legend>Payment Details</legend>
                    <div class="payment-type form-group">
                        <label class="control-label col-sm-3">Payment Method</label>
                        <div class="col-sm-9">
                            <button type="button"
                                    class="btn [[pmt_method === '3' ? 'btn-primary' : 'btn-default' ]]"
                                    value="3"
                                    id="id_btn_cc"
                                    on-click="@this.set_pmt_method('3')"
                                    [[recurring ? "disabled" : "" ]]
                                    >Credit card
                            </button>
{#                    <button type="button"#}
{#                            class="btn [[pmt_method === '4' ? 'btn-primary' : 'btn-default' ]]"#}
{#                            id="id_btn_paypal"#}
{#                            value="4"#}
{#                            on-click="@this.set_pmt_method('4')"#}
{#                            [[recurring ? "disabled" : "" ]]#}
{#                            >Paypal#}
{#                    </button>#}
                            <button type="button"
                                    class="btn [[pmt_method === '1' ? 'btn-primary' : 'btn-default' ]]"
                                    id="id_btn_bank_transfer"
                                    on-click="@this.set_pmt_method('1')"
                                    value="1">Bank transfer
                            </button>
                        </div>
                    </div>
                        <p id="id_recurring_notification" class="col-sm-offset-3 [[recurring ? '' : 'collapse' ]]">
                            <strong>Note:</strong> We currently only accept monthly donations via bank transfer.
                        </p>
                    <hr />

                    <div class="payment-subsections" id="id_payment_options">
                        <div class="payment-subsection [[pmt_method != '1' ? 'collapse' : '' ]]" id="id_bank_transfer">
                            <p>After you submit this form, we will give you our account details and a unique reference number.</p>
                            [[#if recurring]]
                            <p>You then need to log in to your bank and create a periodic monthly transfer using these details.</p>
                            <p>You can stop your donation or change the amount at any time.</p>
                            [[else]]
                            <p>You then need to log in to your bank and make a bank transfer using these details.</p>
                            [[/if recurring]]
                        </div>

                        <div class="payment-subsection [[pmt_method != '3' ? 'collapse' : '' ]]" id="id_credit_card">
                            {% pin_form %}
                        </div>
                    </div>
                </div>
            </div>

            <p>
                Having a problem donating? Please let us know at <a href="mailto://info@effectivealtruiusm.org.au">info@effectivealtruism.org.au</a>.
            </p>

            <div class="form-actions">
                <button type="submit"
                        class="btn btn-success btn-lg pull-right subscribe"
                        value="Submit">
                    Submit
                </button>
            </div>
        </form>

        <div align="center" id="id_paypal" class="payment_option [[pmt_method != '4' ? 'collapse' : '' ]]">
            {{ paypal_form.render }}
        </div>
    </div>

    <div class="donation-step" id="step-3">
        <div class="col-xs-6 col-md-offset-3">
            <div class="col-md-12">

            </div>
        </div>
    </div>
</div>
</script>

    <script>
    var charity_database_ids = {{ charity_database_ids|safe }};
    var ractive = new Ractive({
        el: '#ractive_base',
        template: '#ractive_template',
        data: {
            step: 1,
            recurring: null,
            donation_amount: null,
            is_custom_amount: false,
            pmt_method: '3',
            selected_charity_id: null,
            selected_charity: null,
            charities: charities
        },
        delimiters: ['[[', ']]'],

        set_step: function (i) {
            ractive.set({step: i});
            if (i == 2) {
                validate_cc()
            }
        },

        charity_click: function (name) {
            var id = charity_database_ids[name];
            var selected_charity = charities.find(function (x) {
                return x.name === name;
            });
            ractive.set({
                            step: 2,
                            selected_charity_id: id,
                            selected_charity: selected_charity
                        });
            // For paypal
            // document.getElementById('id_item_name').value = 'Donation: '.concat(selected_charity.website_label);
            validate_cc();
        },

        set_recurring: function (is_recurring) {
            ractive.set({recurring: is_recurring});
            if (is_recurring) {
                ractive.set_pmt_method('1');
            }
        },

        set_donation_amount: function (amount) {
            this.hide_other_donation_amount();
            ractive.set({donation_amount: amount});
        },

        show_other_donation_amount: function () {
            ractive.set({donation_amount: ""});
            ractive.set({is_custom_amount: true});
        },

        hide_other_donation_amount: function () {
            ractive.set({is_custom_amount: false});
        },

        set_pmt_method: function (pmt_method) {
            ractive.set({pmt_method: pmt_method});
        }
    });

    function callPinAPI(callBack) {
        var $form = $('#id_pledge_form'),
            $errors = $form.find('.errors'),
            $submitButton = $form.find(":submit");

        // $errors.hide();

        // Disable the submit button to prevent multiple clicks
        $submitButton.attr({disabled: true});

        // Convert expiry string into year and month values for Pin
        var expiry = $.payment.cardExpiryVal($('#cc-expiry').val())

        // Fetch details required for the createToken call to Pin
        var card = {
            number: $('#cc-number').val(),
            name: $('#cc-name').val(),
            expiry_month: expiry.month,
            expiry_year: expiry.year,
            cvc: $('#cc-cvc').val(),
            address_line1: $('#address-line1').val(),
            address_line2: $('#address-line2').val(),
            address_city: $('#address-city').val(),
            address_state: $('#address-state').val(),
            address_postcode: $('#address-postcode').val(),
            address_country: $('#address-country').val()
        };

        Pin.createToken(card, handlePinResponse);

        function handlePinResponse(response) {
            console.log(response)
            var $form = $('#id_pledge_form');

            if (response.response) {
                // Add the card token and ip address of the customer to the form
                // You will need to post these to Pin when creating the charge.
                $('<input>')
                    .attr({type: 'hidden', name: 'card_token'})
                    .val(response.response.token)
                    .appendTo($form);
                $('<input>')
                    .attr({type: 'hidden', name: 'ip_address'})
                    .val(response.ip_address)
                    .appendTo($form);

                callBack()
            } else {
                var $errorList = $errors.find('ul');

                $errors.find('h3').text(response.error_description);
                $errorList.empty();

                if (response.messages) {
                    $.each(response.messages, function (index, errorMessage) {
                        $('<li>')
                            .text(errorMessage.message)
                            .appendTo($errorList);
                    });
                }

                $errors.show();
                $submitButton.removeAttr('disabled');
            }
        }
    }

    function submitForm() {
        var data = {
            // Extra fields that Django wants, that aren't in the form data:
            payment_method: ractive.get('pmt_method'),
            recipient_org: ractive.get('selected_charity_id'),
            recurring: ractive.get('recurring')
        };
        // Now we add all the data from the form:
        var formData = $('#id_pledge_form').serializeArray();
        for (var i = 0; i < formData.length; ++i) {
            data[formData[i].name] = formData[i].value;
        }

        $.ajax({
            url : "", // the endpoint
            type : "POST", // http method
            data : data,

            // handle a successful response
            success : function(json) {
                console.log(json); // log the returned json to the console
                console.log("success"); // another sanity check
            },

            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });

        $('#id_pledge_form').find(":submit").removeAttr('disabled')
    }

    ractive.on('submit', function(event) {
        event.original.preventDefault();
        if (ractive.get('pmt_method') === "3") {
            callPinAPI(submitForm);
        } else {
            submitForm()
        }
    });




    </script>
</body>
</html>
