{% load humanize %}
{% load bootstrap3 %}
{% load static %}
{% load pin_payment_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"
          integrity="" crossorigin="anonymous">

    <!-- Optional theme -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"-->
          <!--integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">-->

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>

    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.16.0/jquery.validate.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.payment/3.0.0/jquery.payment.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.16.0/additional-methods.min.js"></script>

    <script src='http://cdn.ractivejs.org/latest/ractive.min.js'></script>


    {{ form.media }}

    {% pin_header "test" %}

</head>

<body>


<div id="ractive_base"></div>

<script id="ractive_template" type="text/ractive">
<div class="container">
    <div class="stepwizard">
        <div class="stepwizard-row setup-panel">
            <div class="stepwizard-step">
                <a href="#" type="button" class="btn btn-circle [[step === 1 ? 'current-step' : 'completed-step' ]]" on-click="@this.set_step(1)">1</a>
                <p>Charities</p>
            </div>
            <div class="stepwizard-step">
                <a href="#" type="button" class="btn btn-circle [[step === 2 ? 'current-step' : step > 2 ? 'completed-step' : 'disabled-step' ]]" disabled=[[step < 2]] on-click="@this.set_step(2)">2</a>
                <p>Payment</p>
            </div>
            <div class="stepwizard-step">
                <a href="#" type="button" class="btn btn-circle [[step === 3 ? 'current-step' : 'disabled-step' ]]" disabled=[[step < 3]] on-click="@this.set_step(3)">3</a>
                <p>Confirmation</p>
            </div>
        </div>
    </div>
</div>

<div class="container" >
    <div class="row setup-content [[step !== 1 ? 'collapse' : '']]" id="step-1">
        <div class="charities-container">
            [[#charities:i]]
                [[#if show_on_website ]]
                <div class="charity" style="vertical-align: text-bottom">
                    <div class="charity-info">
                        <img class="charity-img" style="margin-top:[[ image_top_margin ]]px;"
                             src="static/[[ website_image ]]" alt="[[ website_label ]]">
                        <h2 class="charity-title">[[ website_label ]]</h2>
                    </div>
                    <div class="hover-overlay">
                        <a class="charity-details charityClick" on-click='@this.charity_click(name)' href="#">
                            <b>[[ website_label ]] </b> [[ website_description ]]
                        </a>
                    </div>
                </div>
                [[/if ]]
            [[/charities]]
        </div>
    </div>

    [[#if selected_charity.name==='Against Malaria Foundation' & step === 2]]
        <br>
        You can make a tax deductible donation to the Against Malaria Foundation directly at
        <a href='https://www.againstmalaria.com/Donation.aspx'>https://www.againstmalaria.com/Donation.aspx</a>
    [[/if ]]

    <div class="row setup-content [[(step !== 2 | selected_charity.name==='Against Malaria Foundation') ? 'collapse' : '']]" id="step-2">

        [[#if selected_charity]]
        [[! We need to enclose this in an 'if' to avoid a 404 when the charity is not set but we try to load its logo. ]]
        <div class="selected-charity-box">
            <img class="charity-img" src="static/[[ selected_charity.website_image ]]">
            <p class="donation-info">
                You have earmarked your donation for [[ selected_charity.name ]].<br/>
                100% of your donation will be granted to them.
            </p>
        </div>
        [[/if ]]
        <form method='post' action='' class='pin' id='id_pledge_form'>
            {% csrf_token %}
            <h1>How would you like to donate?</h1>
            <div class="donation-type-section">
                <div data-toggle="buttons">
                    <div class="btn-group">
                        <button type="button"
                                class="btn btn-default btn-lg btn-recurring btn-toggle [[recurring == false ? 'btn-primary' : 'btn-default' ]]"
                                on-click='@this.set_recurring(false)'>One-Time
                        </button>

                        <button type="button"
                                class="btn btn-default btn-lg btn-recurring btn-toggle [[recurring ? 'btn-primary' : 'btn-default' ]]"
                            on-click='@this.set_recurring(true)'>Monthly
                        </button>
                    </div>
                </div>
                <p id="id_recurring_notification" class="[[recurring ? '' : 'collapse' ]]">
                    We currently only accept monthly donations via bank transfer.
                </p>
            </div>
            <br>
            <div class="text-center">
                    {% for amt_text, amt_val in form.donation_amounts %}
                        <button type="button" class="btn btn-lg btn-toggle btn-amt [[amount === {{ amt_val }} ? 'btn-primary' : 'btn-default' ]]" on-click='@this.set_amount({{ amt_val }})'
                                id="id_{{ amt_val }}"
                                value={{ amt_val }}>{{ amt_text }}</button>
                    {% endfor %}

                    <button type="button" class="btn btn-lg btn-toggle btn-amt [[amount === 'other' ? 'btn-primary' : 'btn-default' ]]" on-click="@this.set_amount('other')"
                            value="other">Other
                    </button>
                </div>
            <br>
            <div class="panel panel-default credit-card-box">
            <div class="panel-body">
            {% for field in form %}
                <div class="form-group [[ hidden_initial.indexOf("{{ field.name }}") === -1 ? "" : "collapse" ]]" id="id_formgroup_{{ field.name }}">
                    {% if field.name not in form.hide_labels %}
                        {% bootstrap_label field.label label_class="labels" %}
                    {% endif %}
                    {% bootstrap_field field layout="vertical" vertical_field_class="col-md-3" show_label=False %}
                </div>
            {% endfor %}
            </div>
            </div>

            <br>
            <div class="text-center">
                    <button type="button"
                            class="btn btn-default btn-lg btn-toggle btn-pmt-method [[pmt_method === '3' ? 'btn-primary' : 'btn-default' ]]"
                            value="3"
                            id="id_btn_cc"
                            on-click="@this.set_pmt_method('3')"
                            [[recurring ? "disabled" : "" ]]
                            >Credit card
                    </button>
{#                    <button type="button"#}
{#                            class="btn btn-default btn-lg btn-toggle btn-pmt-method [[pmt_method === '4' ? 'btn-primary' : 'btn-default' ]]"#}
{#                            id="id_btn_paypal"#}
{#                            value="4"#}
{#                            on-click="@this.set_pmt_method('4')"#}
{#                            [[recurring ? "disabled" : "" ]]#}
{#                            >Paypal#}
{#                    </button>#}
                    <button type="button"
                            class="btn btn-default btn-lg btn-toggle btn-pmt-method [[pmt_method === '1' ? 'btn-primary' : 'btn-default' ]]"
                            id="id_btn_bank_transfer"
                            on-click="@this.set_pmt_method('1')"
                            value="1">Bank transfer
                    </button>
            </div>

            <div id="id_payment_options">
                <div class="payment_option [[pmt_method != '1' ? 'collapse' : '' ]]" id="id_bank_transfer">
                    <br>
                    Donations by bank transfer take two steps to set up.<br><br>
                    First, you must register your intent to make a single, or recurring, transfer to our account by completing the form below. You will receive a unique code to use in the transaction.<br><br>
                    Second, you must setup the bank transfer with your bank, using the unique code supplied. <br><br>
                    For a recurring transfer, you must create the corresponding recurring transaction with your bank.
                    <div class="form-actions">
                        <button type="submit"
                                class="btn btn-success btn-lg pull-right subscribe"
                                value="Submit"
                                id="id_btn_submit">Submit
                        </button>
                    </div>


                </div>

                <br><br>
                <div class="payment_option [[pmt_method != '3' ? 'collapse' : '' ]]" id="id_credit_card">
                    {% pin_form %}

                    <div class="form-actions">
                        <button type="submit"
                                class="btn btn-success btn-lg pull-right subscribe"
                                value="Submit"
                                id="id_btn_submit">Submit
                        </button>
                    </div>
                </div>

            </div>
        </form>

        <div align="center" id="id_paypal" class="payment_option [[pmt_method != '4' ? 'collapse' : '' ]]">
            {{ paypal_form.render }}
        </div>

    </div>

    <div class="row setup-content" id="step-3">
        <div class="col-xs-6 col-md-offset-3">
            <div class="col-md-12">

            </div>
        </div>
    </div>
</div>
</script>

    <script>
    var charity_database_ids = {{ charity_database_ids|safe }};
    var ractive = new Ractive({
        el: '#ractive_base',
        template: '#ractive_template',
        data: {
            step: 1,
            recurring: null,
            amount: null,
            pmt_method: null,
            selected_charity_id: null,
            selected_charity: null,
            charities: charities,
            hidden_initial: ['amount', 'payment_method', 'recipient_org', 'recurring']
        },
        delimiters: ['[[', ']]'],

        set_step: function (i) {
            ractive.set({step: i});
            if (i == 2) {
                validate_cc()
            }
        },

        charity_click: function (name) {
            var id = charity_database_ids[name];
            var selected_charity = charities.find(function (x) {
                return x.name === name;
            });
            ractive.set({
                            step: 2,
                            selected_charity_id: id,
                            selected_charity: selected_charity
                        });
            document.getElementById('id_recipient_org').value = id;
            // For paypal
            document.getElementById('id_item_name').value = 'Donation: '.concat(selected_charity.website_label);
            validate_cc();
        },


        set_recurring: function (is_recurring) {
            ractive.set({recurring: is_recurring});
            document.getElementById('id_recurring').checked = is_recurring;
        },

        set_amount: function (amount) {
            ractive.set({amount: amount});

            if (amount == 'other') {
                $("#id_formgroup_amount").removeClass('collapse');
                $('input[name=amount]').each(function () {
                    this.value = "";
                });
            } else {
                $("#id_formgroup_amount").addClass('collapse');
                $('input[name=amount]').each(function () {
                    this.value = amount;
                });
            }
        },

        set_pmt_method: function (pmt_method) {
            ractive.set({pmt_method: pmt_method});
            document.getElementById('id_payment_method').value = pmt_method;
        },

    });


    </script>
</body>
</html>
