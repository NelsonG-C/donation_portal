# nginx site configuration for EAA donation portal
#
# ***** DO NOT EDIT THIS FILE *****
#
# This file is managed by Salt via { source }

# Note that we require HTTPS in production. However, as the TLS connections are
# terminated on the AWS Elastic Load Balancer, we need to advise Django that a
# given connection should be treated as secured (HTTPS) even if it came over an
# unsecured connection (HTTP). We can do this by inspecting the value of the
# X-FORWARDED-PROTO header which the ELB sets and can then subsequently issue a
# HTTPS redirect to any clients which access URLs over unencrypted connections.

{% set https_handling %}
{% if config.check_x_forwarded_proto_header %}
# Redirect the client to the HTTPS endpoint if they're not using it
if ($http_x_forwarded_proto != 'https') {
    rewrite ^ https://$host$request_uri? permanent;
}
{% endif %}
{% endset %}

# Django web application
upstream donations {
    ip_hash;
    server                      {{ config.upstream.donations.server }} fail_timeout=0;
}

# Donations site
server {
    # Virtual host
    listen                      80 default_server;
    server_name                 {{ config.server.donations.server_name }};
    root                        {{ config.server.donations.root }};

    # Logs
    access_log                  /var/log/nginx/donations.access.log;
    error_log                   /var/log/nginx/donations.error.log;

    # More aggressive keep-alive timeouts
    keepalive_timeout           15;

    # Static files
    location /static {
        alias                   {{ config.server.donations.root }}/tmp/static;
    }

    location / {
        {{ https_handling | indent(8) }}
        # Going through the proxy is *mandatory* or we'll end up exposing the
        # site root directly to clients. We also ensure we set required HTTP
        # headers so that the Django application is aware we're proxying an
        # HTTPS connection over HTTP (so that it correctly returns HTTPS URLs).
        proxy_redirect          off;
        proxy_set_header        Host                    $http_host;
        proxy_set_header        X-Forwarded-For         $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto       $http_x_forwarded_proto;
        proxy_pass              http://donations;
    }
}

# vim: cc=80 tw=79 ts=4 sw=4 sts=4 et sr
